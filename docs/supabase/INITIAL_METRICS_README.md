# Защита от мошенничества с метриками

## Проблема
Инфлюенсер может отправить старую публикацию с большим количеством просмотров/лайков и сразу получить оплату.

## Решение
Система записывает **начальные метрики** (initial_metrics) при отправке публикации и считает только **прирост**:

```
Оплата = прирост метрик = текущие метрики - начальные метрики
```

## Как это работает

### 1. При отправке публикации
Когда инфлюенсер добавляет ссылку на пост, система:
- Извлекает ID поста из URL
- Делает запрос к Instagram API
- Сохраняет текущие метрики как `initial_metrics`

### 2. При проверке (каждый час)
Cron-задача:
- Получает текущие метрики с Instagram
- Вычисляет прирост: `delta = current - initial`
- Проверяет достижение целей по приросту
- Автоматически оплачивает при достижении целей

### 3. Пример
```
Инфлюенсер отправил пост с:
- Лайки: 500 (initial_metrics)
- Просмотры: 2000 (initial_metrics)

Через день пост набрал:
- Лайки: 750 (current)
- Просмотры: 5000 (current)

Прирост для оплаты:
- Лайки: 750 - 500 = 250 ✅
- Просмотры: 5000 - 2000 = 3000 ✅

Если задание требовало 200 лайков → оплата выполняется
```

## Установка

### Шаг 1: Выполнить миграцию
Выполните в Supabase SQL Editor:
```bash
supabase/migrations/migration_initial_metrics.sql
```

Это добавит:
- Поле `initial_metrics` в таблицу `task_submissions`
- Триггер для автоматической записи начальных метрик
- Обновленную функцию `auto_check_submissions_metrics` с расчетом прироста

### Шаг 2: Обновить auto_metrics_check.sql
Замените файл на новую версию с логикой вычисления дельты.

### Шаг 3: Установить ACCESS_TOKEN
В файлах замените:
```sql
v_access_token TEXT := 'YOUR_INSTAGRAM_ACCESS_TOKEN';
```

На реальный токен Instagram Graph API.

## Для существующих публикаций

Если есть старые submissions без `initial_metrics`, система автоматически:
1. При первой проверке сохранит текущие метрики как начальные
2. Со следующей проверки будет считать прирост

Или вручную:
```sql
-- Установить текущие метрики как начальные для всех старых submissions
UPDATE task_submissions 
SET initial_metrics = current_metrics 
WHERE initial_metrics IS NULL AND current_metrics IS NOT NULL;
```

## Безопасность

✅ **Защита от старых постов** - считается только прирост после отправки  
✅ **Защита от отрицательных значений** - используется GREATEST(delta, 0)  
✅ **Автоматическая инициализация** - если initial_metrics нет, устанавливается при первой проверке  
✅ **Timestamp** - сохраняется время записи метрик для аудита

## Логи для отладки

Функция выводит детальные логи:
```
Metrics for submission UUID: 
  current(views=5000, likes=750, comments=50)
  initial(views=2000, likes=500, comments=30)
  delta(views=3000, likes=250, comments=20)
```

Проверить логи можно в Supabase Dashboard → Logs → Postgres Logs
